<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorteador Rindo e Apoiando!!</title>
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #06b6d4;
      --muted: #94a3b8;
      --glass: rgba(255, 255, 255, 0.03)
      
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, Segoe UI, Arial;
      color: #e6eef6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px
    }

    body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: url('https://raw.githubusercontent.com/luyan-tamec/roleta-leoeisa/refs/heads/main/d9da3fab-4aec-408c-b01c-8df60aefe6e5.png')
    center/cover no-repeat;
    filter: blur(2px) brightness(0.6);
    z-index: -2;
    }

    body::after {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: -1;
    }

    .app {
      width: 100%;
      max-width: 980px
      
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px
      
    }

    h1 {
      font-size: 30px;
      margin: 0
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px
      
    }

    .card {
      background: var(--card);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.9)
      
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 8px
    }

    input[type=text],
    input[type=search],
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: var(--glass);
      color: inherit
    }

    button {
      padding: 10px 12px;
      border-radius: 8px;
      border: 0;
      background: var(--accent);
      color: #022;
      cursor: pointer
    }

    button.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--muted)
    }

    ul.names {
      list-style: none;
      padding: 0;
      margin: 12px 0;
      max-height: 360px;
      overflow: auto
    }

    ul.names li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 6px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.19), transparent)
    }

    .small {
      font-size: 13px;
      color: var(--muted)
    }

    /* painel do ganhador */
    .winner {
      font-size: 30px;
      text-align: center;
      padding: 18px;
      border-radius: 10px;
      margin-top: 15px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.08), rgba(6, 182, 212, 0.25));
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
      transition: transform .18s ease, opacity .08s ease;
      position: relative;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #ffdcdc
    }

    .tmi-row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    footer {
      margin-top: 12px;
      text-align: center;
      color: var(--muted);
      font-size: 13px
    }

    @media(max-width:900px) {
      .grid {
        grid-template-columns: 1fr;
        max-width: 720px
      }

      .card {
        margin-bottom: 12px
      }
    }

    .winner.glow {
      animation: glowPulse 0.6s ease-in-out infinite alternate;
      box-shadow:
        0 0 12px rgba(6, 182, 212, 0.8),
        0 0 24px rgba(6, 182, 212, 0.6),
        0 0 36px rgba(6, 182, 212, 0.3);
      border-color: #3df2ff;
    }

    @keyframes glowPulse {
      0% {
        transform: scale(1);
        box-shadow:
          0 0 10px rgba(0, 255, 255, 0.5),
          0 0 20px rgba(0, 255, 255, 0.3);
      }

      100% {
        transform: scale(1.09);
        box-shadow:
          0 0 18px rgb(255, 6, 172),
          0 0 40px rgba(246, 29, 235, 0.7),
          0 0 65px rgba(0, 255, 255, 0.4);
      }
    }
    #btnLeft {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 10px;
      background: rgba(30, 33, 207, 0.5);
      color: #fff;
      text-decoration: none;
      border-radius: 15px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      z-index: 9999;
    }
  </style>
</head>

<body>
  <a id="btnLeft" href="index.html">Voltar</a>
  <div class="app">
    <header>
      <h1>Sorteador Rindo e Apoiando !</h1>
      <div class="small"></div>
    </header>

    <div class="grid">
      <section class="card" id="manualCard">
        <h3>Adicionar nomes:</h3>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="nameInput" type="text" placeholder="Digite nome ou usu√°rio" />
          <button id="addBtn">Adicionar</button>
        </div>

        <div class="controls" id="controlsRow">
          <button id="drawBtn">Sortear</button>
          <input id="durationInput" type="number" min="200" value="" style="width:110px" placeholder="tempo em ms" />
          <button id="shuffleBtn" class="ghost">Embaralhar</button>
          <button id="removeLast" class="ghost">Remover √∫ltimo</button>
          <button id="clearAll" class="ghost">Limpar tudo</button>
          <button id="exportCsv" class="ghost">Exportar CSV</button>
          <button id="importCsv" class="ghost">Importar CSV</button>
        </div>

        <div id="extraOptions" style="margin-top:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <label class="small"><input type="checkbox" id="autoRemoveWinner" /> Remover vencedor automaticamente</label>
          <label class="small"><input type="checkbox" id="noRepeatWinner" /> N√£o repetir √∫ltimo vencedor</label>
        </div>

        <input type="file" id="fileInput" accept=".csv" style="display:none" />

        <!-- CAIXA DO GANHADOR FIXA AQUI -->
        <div id="winnerBox" class="winner" style="display:none;opacity:1"></div>

        <!--  lista de usuarios abaixo do box do vencedor -->
        <div style="margin-top:12px">
          <div class="small">Lista de participantes</div>
          <ul id="namesList" class="names"></ul>
        </div>

        <div id="jsStatus" class="status" style="display:none"></div>

      </section>

      <aside class="card" id="tmiCard">
        <h3>Captura de Chat</h3>
        <p class="small">Conecta ao canal e adiciona os usuarios que digitarem a <strong>palavra-chave</strong>.
        </p>

        <label class="small">Nome do Canal <input id="channelInput" type="text" placeholder="ex: isaroza_"
            style="margin-top:6px" /></label>
        <label class="small">Palavra-chave <input id="keywordInput" type="text" placeholder="ex: !Rindoeapoiando"
            style="margin-top:6px" /></label>

        <div style="margin-top:8px" class="tmi-row">
          <select id="matchType">
            <option value="exact" style="color: black;">Mensagem exata</option>
            <option value="contains" style="color: black;">Cont√©m a palavra</option>
            <option value="starts" style="color: black;">Come√ßa com</option>
          </select>
          <button id="connectBtn">Conectar</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Status: <span id="tmiStatus">desconectado</span></div>
          <div class="small" style="margin-top:8px">Entrada do chat (√∫ltimas 6)</div>
          <ul id="chatLog" class="names" style="max-height:180px"></ul>
        </div>

        <div style="margin-top:12px">
          <label class="small"><input type="checkbox" id="filterDuplicates" checked /> N√£o adicionar duplicados</label>
        </div>
      </aside>
    </div>

    <footer>Diga Nao ao Cancelamento ! </footer>
  </div>

  <script src="tmi.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      let names = [];
      let lastWinner = localStorage.getItem('sorteio_last_winner') || null;

      const nameInput = document.getElementById('nameInput');
      const addBtn = document.getElementById('addBtn');
      const namesList = document.getElementById('namesList');
      const drawBtn = document.getElementById('drawBtn');
      const removeLast = document.getElementById('removeLast');
      const clearAll = document.getElementById('clearAll');
      const winnerBox = document.getElementById('winnerBox');
      const autoRemoveWinner = document.getElementById('autoRemoveWinner');
      const noRepeatWinner = document.getElementById('noRepeatWinner');
      const exportCsv = document.getElementById('exportCsv');
      const importCsv = document.getElementById('importCsv');
      const fileInput = document.getElementById('fileInput');
      const durationInput = document.getElementById('durationInput');
      const shuffleBtn = document.getElementById('shuffleBtn');
      const jsStatus = document.getElementById('jsStatus');

      // script do TMI
      const channelInput = document.getElementById('channelInput');
      const keywordInput = document.getElementById('keywordInput');
      const connectBtn = document.getElementById('connectBtn');
      const tmiStatus = document.getElementById('tmiStatus');
      const chatLog = document.getElementById('chatLog');
      const filterDuplicates = document.getElementById('filterDuplicates');
      const matchType = document.getElementById('matchType');

      function logStatus(msg, isError) {
        jsStatus.style.display = 'block';
        jsStatus.style.color = isError ? '#ff9a9a' : '#bcdffb';
        jsStatus.textContent = msg;
      }
      function clearStatus() { jsStatus.style.display = 'none'; }

      function saveLS() { localStorage.setItem('sorteio_nomes', JSON.stringify(names)); }
      function loadLS() { const d = localStorage.getItem('sorteio_nomes'); if (d) { names = JSON.parse(d); } }
      loadLS();

      function escapeHtml(s) {
        return String(s).replace(/[&<>\"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;' }[c]));
      }

      function renderList() {
        namesList.innerHTML = '';
        names.forEach((n, i) => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${escapeHtml(n)}</span> <button class="ghost removeBtn" data-i="${i}">‚úñ</button>`;
          namesList.appendChild(li);
        });
        document.querySelectorAll('.removeBtn').forEach(btn => {
          btn.onclick = () => {
            names.splice(Number(btn.dataset.i), 1);
            saveLS();
            renderList();
          };
        });
        saveLS();
      }

      // adicao manual
      addBtn.onclick = () => {
        const v = nameInput.value.trim();
        if (!v) { logStatus('Digite um nome.', true); return; }
        names.push(v);
        nameInput.value = '';
        renderList();
        clearStatus();
      };
      nameInput.addEventListener('keydown', e => { if (e.key === 'Enter') addBtn.click(); });

      removeLast.onclick = () => { names.pop(); renderList(); };
      clearAll.onclick = () => { if (confirm('Limpar tudo?')) { names = []; renderList(); winnerBox.style.display = 'none'; } };

      // exportar o csv
      exportCsv.onclick = () => {
        if (!names.length) return alert('Lista vazia.');
        const csv = names.map(n => `"${n.replace(/"/g, '""')}"`).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'lista_sorteio.csv';
        a.click();
      };

      // importar o csv
      importCsv.onclick = () => fileInput.click();
      fileInput.onchange = () => {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const lines = String(reader.result).split(/\r?\n/).map(l => l.trim()).filter(Boolean);
          names.push(...lines);
          renderList();
        };
        reader.readAsText(file);
      };

      // embaralhador
      function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]] } }
      shuffleBtn.onclick = () => { shuffleArray(names); renderList(); };

      // tic do audio
      const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : null;
      let tickOsc = null, tickGain = null;
      // üîä Som final do vencedor
      let winnerSound = new Audio("winner.mp3");
      winnerSound.volume = 1.0; // pode ajustar

      // Remove o glow ap√≥s X milissegundos
      function removeGlowAfter(delay = 5000) {
        setTimeout(() => {
          winnerBox.classList.remove("glow");
        }, delay);
      }



      function startTick() {
        /* if(!audioCtx || tickOsc) return;
         tickOsc = audioCtx.createOscillator();
         tickGain = audioCtx.createGain();
         tickOsc.type='sine';
         tickOsc.frequency.value=1000;
         tickGain.gain.value=0.002;
         tickOsc.connect(tickGain);
         tickGain.connect(audioCtx.destination);
         tickOsc.start();*/
         winnerBox.classList.remove("glow");
        //removeGlowAfter(5000);



      }
      function stopTick() {
        if (!tickOsc) return;
        tickOsc.stop();
        tickOsc.disconnect();
        tickGain.disconnect();
        tickOsc = null;


      }


      function chooseFinal(pool) {
        if (!noRepeatWinner.checked || !lastWinner || pool.length < 2)
          return pool[Math.floor(Math.random() * pool.length)];
        let final = null;
        let tries = 0;
        while (tries < 20) {
          final = pool[Math.floor(Math.random() * pool.length)];
          if (final !== lastWinner) return final;
          tries++;

        }

        return final;
      }

      drawBtn.onclick = () => {
        if (!names.length) { logStatus('Adicione nomes antes de sortear.', true); return; }

        const duration = Math.max(200, Number(durationInput.value) || 2000);
        const start = Date.now();
        const pool = names.slice();

        winnerBox.style.display = 'block';
        winnerBox.textContent = 'Sorteando...';

        if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        startTick();

        const interval = setInterval(() => {
          winnerBox.textContent = pool[Math.floor(Math.random() * pool.length)];
          winnerBox.style.opacity = '0.6';
          setTimeout(() => winnerBox.style.opacity = '1', 60);

          if (Date.now() - start >= duration) {
            clearInterval(interval);
            stopTick();

            const final = chooseFinal(pool);
            winnerBox.textContent = final;

            //  Ativar efeito glow
            winnerBox.classList.add("glow");


            // üîä Tocar som especial
            winnerSound.currentTime = 0;
            winnerSound.play().catch(e => console.log("Som bloqueado pelo navegador"));


            winnerBox.style.transform = 'scale(1.18)';
            setTimeout(() => winnerBox.style.transform = 'scale(1)', 200);

            lastWinner = final;
            localStorage.setItem('sorteio_last_winner', final);

            if (autoRemoveWinner.checked) {
              const idx = names.indexOf(final);
              if (idx > -1) { names.splice(idx, 1); renderList(); }
            } else saveLS();

            clearStatus();
          }
        }, 70);
      };

      // TMI
      let tmiClient = null;

      function addNameFromTwitch(username) {
        if (filterDuplicates.checked && names.includes(username)) return;
        names.push(username);
        renderList();
      }

      connectBtn.onclick = () => {
        if (tmiClient) {
          tmiClient.disconnect();
          tmiClient = null;
          tmiStatus.textContent = 'desconectado';
          connectBtn.textContent = 'Conectar';
          return;
        }

        const channel = channelInput.value.trim();
        const keyword = keywordInput.value.trim();

        if (!channel || !keyword) {
          logStatus('Preencha canal e palavra-chave.', true);
          return;
        }

        tmiClient = new tmi.Client({ connection: { reconnect: true, secure: true }, channels: [channel] });

        tmiClient.connect().then(() => {
          tmiStatus.textContent = 'conectado: #' + channel;
          connectBtn.textContent = 'Desconectar';
        });

        tmiClient.on('message', (ch, user, msg, self) => {
          if (self) return;

          const who = user["display-name"] || user.username;
          const li = document.createElement('li');
          li.innerHTML = `<strong>${escapeHtml(who)}:</strong> ${escapeHtml(msg)}`;
          chatLog.prepend(li);
          while (chatLog.children.length > 6) chatLog.removeChild(chatLog.lastChild);

          const kw = keyword.toLowerCase();
          const m = msg.toLowerCase();
          let matched = false;

          if (matchType.value === 'exact') matched = m === kw;
          else if (matchType.value === 'contains') matched = m.includes(kw);
          else if (matchType.value === 'starts') matched = m.startsWith(kw);

          if (matched) addNameFromTwitch(who);
        });
      };

      renderList();
      clearStatus();

    });
  </script>
</body>

</html>